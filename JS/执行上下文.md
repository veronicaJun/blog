# 执行上下文

## 1. 执行上下文

### 什么是执行上下文?

- 评估和执行 JavaScript 代码的环境的抽象概念。每当 Javascript 代码在运行的时候，它都是在执行上下文中运行。

### 执行上下文的类型

- 全局执行上下文: 这是默认或者说基础的上下文，任何不在函数内部的代码都在全局上下文中
    - 创建 window 对象
    - 让 this 的值等于 window
- 函数执行上下文: 每当一个函数被调用时, 都会为该函数创建一个新的上下文
- Eval 函数执行上下文: 执行在 eval 函数内部的代码也会有它属于自己的执行上下文

## 2. 执行栈

### 什么是执行栈?

- 执行栈, 用来存储代码运行时创建的执行上下文的栈.

### 执行栈运行机制

1. JS 引擎运行脚本时,先创建一个全局执行上下文并压入当前执行栈.
2. 当遇到一个函数调用,就会压入一个为该函数创建的执行上下文.
3. 引擎先执行栈顶的函数,执行结束后,将该函数的执行上下文弹出.
4. 到达下一个上下文.

## 3. 怎么创建执行上下文？

### 1.创建阶段

1. this绑定
    1. 全局执行上下文中, this 执行全局对象
    2. 函数执行上下文中, this 取决于调用者, 如果是引用对象, 则指向该对象, 否则指向全局对象或 undefined(严格模式)
2. 创建词法环境组件
    - 两个组件:
        1. 环境记录器: 存错变量和函数声明的实际位置
            - 分类
                - 声明式环境记录器: 存储变量/函数/参数
                - 对象环境记录器: 用来定义出现在全局上下文中的变量和函数的关系
            - 简而言之
                - 全局环境中, 环境记录器是对象环境记录器
                - 函数环境中, 环境记录器是声明式环境记录器
        2. 外部环境引用: 可以访问其父级词法环境(作用域)
3. 创建变量环境组件
    - 变量环境,也是一个词法环境, 其环境记录器: 持有变量声明语句在执行上下文中创建的绑定关系

### 2.执行阶段

1. 完成对所有变量的分配
2. 执行代码

1. 执行上下文类型
    - 全局执行上下文
        - 任何不在函数内部的都是全局执行上下文
        - 它首先会创建一个全局对象 window ，并且设置 this 的值等于全局对象
        - 一个程序中只有一个全局执行上下文。
    - 函数执行上下文
        - 当一个函数被调用时，就会为该函数创建一个新的执行上下文，函数的上下文可以有任意多个。
    - eval函数执行上下文
        - 执行在 eval 函数中的代码会有属于他自己的执行上下文

2. 执行上下文栈
    - JavaScript引擎使用执行上下文栈来管理执行上下文
        - 当JavaScript执行代码时
            - 首先遇到全局代码，会创建一个全局执行上下文并且压入执行栈中
            - 每当遇到一个函数调用，就会为该函数创建一个新的执行上下文并压入栈顶，引擎会执行位于执行上下文栈顶的函数
            - 当函数执行完成之后，执行上下文从栈中弹出，继续执行下一个上下文
            - 当所有的代码都执行完毕之后，从栈中弹出全局执行上下文

3. 创建执行上下文
    1. 创建阶段
        - this绑定
            - 在全局执行上下文中，this指向全局对象（window对象）
            - 在函数执行上下文中，this指向取决于函数如何调用。
                - 如果它被一个引用对象调用，那么 this 会被设置成那个对象
                - 否则 this 的值被设置为全局对象或者 undefined

        - 创建词法环境组件
            - 词法环境是一种有标识符——变量映射的数据结构，标识符是指变量/函数名，变量是对实际对象或原始数据的引用。
            - 词法环境的内部有两个组件
                - 环境记录器：用来储存变量个函数声明的实际位置
                - 外部环境的引用：可以访问父级作用域

        - 创建变量环境组件
            - 变量环境也是一个词法环境，其环境记录器持有变量声明语句在执行上下文中创建的绑定关系。

    2. 执行阶段
        此阶段会完成对变量的分配，最后执行完代码。
